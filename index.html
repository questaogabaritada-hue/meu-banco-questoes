<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MENTOR IA - PC (MODO SUBS√çDIO & GEST√ÉO)</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* CSS LEI - MANTIDO INTEGRALMENTE */
        :root { --primary: #2563eb; --bg: #f8fafc; --text: #1e293b; --dark: #0f172a; --accent: #dc2626; }
        body { font-family: 'Inter', sans-serif; margin: 0; background: var(--bg); color: var(--text); }
        .app-container { display: flex; height: 100vh; width: 100vw; }
        .quest-side { flex: 1.2; padding: 40px; overflow-y: auto; border-right: 1px solid #e2e8f0; background: white; }
        .ia-side { flex: 0.8; background: #fff; padding: 25px; overflow-y: auto; border-left: 1px solid #e2e8f0; }
        .container { max-width: 800px; margin: 0 auto; width: 100%; }
        #q-header { color: #94a3b8; font-size: 0.8rem; margin-bottom: 25px; font-weight: 600; border-bottom: 1px solid #f1f5f9; padding-bottom: 15px; display: flex; justify-content: space-between; }
        .texto-associado-wrapper { background: #f8fafc; border: 1px solid #e2e8f0; border-left: 4px solid #3b82f6; margin-bottom: 30px; border-radius: 0 8px 8px 0; overflow: hidden; position: relative; }
        #q-texto-assoc { padding: 20px; max-height: 100px; overflow: hidden; transition: max-height 0.4s ease; font-size: 1.05rem; color: #475569; line-height: 1.6; }
        #q-texto-assoc.expandido { max-height: none; }
        .btn-toggle-texto { width: 100%; padding: 8px; background: #f1f5f9; border: none; border-top: 1px solid #e2e8f0; color: var(--primary); font-weight: bold; cursor: pointer; font-size: 0.8rem; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .html-render { font-size: 1.15rem; line-height: 1.7; color: #1e293b; }
        .html-render img { display: block; max-width: 100%; margin: 25px auto; border-radius: 6px; }
        .alternativas { margin-top: 35px; display: grid; gap: 12px; }
        .opcao { display: flex; padding: 18px; border: 2px solid #f1f5f9; border-radius: 10px; cursor: pointer; transition: 0.2s; align-items: center; }
        .letra { min-width: 32px; height: 32px; background: #f1f5f9; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; margin-right: 15px; color: var(--primary); }
        .correct { border-color: #16a34a !important; background: #f0fdf4 !important; color: #16a34a; }
        .wrong { border-color: #dc2626 !important; background: #fef2f2 !important; color: #dc2626; }
        .ia-box { background: #f8fafc; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0; margin-bottom: 20px; }
        #setup-screen { position: fixed; inset: 0; background: var(--bg); z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .perfil-row { display: flex; align-items: center; justify-content: space-between; background: #f1f5f9; margin-bottom: 8px; border-radius: 8px; padding: 5px 15px; }
        .btn-del { color: #dc2626; cursor: pointer; font-size: 1.2rem; border: none; background: none; }
    </style>
</head>
<body>

<div id="setup-screen">
    <div style="background:white; padding: 40px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 420px; text-align: center;">
        <h2 style="margin-bottom: 20px;">üë§ Gest√£o de Perfis</h2>
        <div id="lista-perfis" style="max-height: 250px; overflow-y: auto; margin-bottom: 20px;">Carregando...</div>
        <input type="text" id="novo-perfil-input" placeholder="Novo Perfil..." style="width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #e2e8f0; border-radius: 8px;">
        <button onclick="criarPerfil()" style="width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">ADICIONAR PERFIL</button>
    </div>
</div>

<div id="main-app" class="app-container" style="display: none;">
    <div class="quest-side">
        <div class="container">
            <div id="q-header">
                <span id="meta-info">SISTEMA DE GERA√á√ÉO DE SUBS√çDIOS</span>
                <span onclick="location.reload()" style="cursor:pointer; color: var(--primary);">üè† VOLTAR</span>
            </div>
            <div id="wrapper-assoc" class="texto-associado-wrapper" style="display:none">
                <div id="q-texto-assoc"></div>
                <button class="btn-toggle-texto" onclick="toggleTexto()">‚ñº Ver texto completo</button>
            </div>
            <div id="q-enunciado" class="html-render"></div>
            <div id="q-alternativas" class="alternativas"></div>
            <button id="btn-next" style="display:none; width: 100%; padding: 18px; background: var(--dark); color: white; border: none; border-radius: 12px; cursor: pointer; margin-top: 25px;" onclick="cicloQuestao()">PR√ìXIMA QUEST√ÉO</button>
        </div>
    </div>

    <div class="ia-side">
        <div class="ia-box" style="border-left: 5px solid var(--primary);">
            <h4 style="margin: 0 0 10px 0; color: var(--primary);">üìñ INTELIG√äNCIA PREVENTIVA (SUBS√çDIO)</h4>
            <div id="preventivo-texto" style="font-size: 0.95rem; line-height: 1.6; color: #334155;">Aguardando quest√£o...</div>
            <div id="save-status" style="font-size: 0.7rem; color: #16a34a; margin-top: 10px; font-weight: bold;"></div>
        </div>
        <div class="ia-box">
            <h4 style="margin: 0 0 5px 0;">üìä BANCO DE DADOS</h4>
            <div id="total-subsidios" style="font-size: 0.8rem; color: #64748b;">Carregando estat√≠sticas...</div>
        </div>
    </div>
</div>

<script>
    const GITHUB_TOKEN = "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";
    const GROQ_KEY = "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";
    const REPO_OWNER = "questaogabaritada-hue"; 
    const REPO_NAME = "meu-banco-questoes";
    const FILE_HISTORICO = "progresso.json";
    const FILE_SUBSIDIOS = "subsidios_cache.json";

    let PERFIL = "";
    let BANCO = [];
    let HISTORICO = {};
    let SUBSIDIOS = {};
    let ATUAL = null;

    async function init() {
        try {
            const resH = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_HISTORICO}`, {
                headers: { Authorization: `token ${GITHUB_TOKEN}` }
            });
            if (resH.ok) {
                const data = await resH.json();
                HISTORICO = JSON.parse(atob(data.content));
                renderizarPerfis();
            }
            const resS = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_SUBSIDIOS}`, {
                headers: { Authorization: `token ${GITHUB_TOKEN}` }
            });
            if (resS.ok) {
                const dataS = await resS.json();
                SUBSIDIOS = JSON.parse(atob(dataS.content));
                document.getElementById('total-subsidios').innerText = `${Object.keys(SUBSIDIOS).length} Subs√≠dios salvos no GitHub.`;
            }
        } catch (e) { console.error("Erro inicial:", e); }
    }

    function renderizarPerfis() {
        const lista = document.getElementById('lista-perfis');
        lista.innerHTML = "";
        Object.keys(HISTORICO).forEach(p => {
            const row = document.createElement('div');
            row.className = 'perfil-row';
            row.innerHTML = `
                <span onclick="entrar('${p}')" style="cursor:pointer; font-weight:600; flex:1;">üë§ ${p}</span>
                <button class="btn-del" onclick="excluirPerfil('${p}')">üóëÔ∏è</button>
            `;
            lista.appendChild(row);
        });
    }

    async function excluirPerfil(nome) {
        if(confirm(`Deseja excluir permanentemente o perfil ${nome}?`)) {
            delete HISTORICO[nome];
            await salvarArquivo(FILE_HISTORICO, HISTORICO);
            renderizarPerfis();
        }
    }

    async function criarPerfil() {
        const nome = document.getElementById('novo-perfil-input').value.trim();
        if(nome && !HISTORICO[nome]) {
            HISTORICO[nome] = [];
            await salvarArquivo(FILE_HISTORICO, HISTORICO);
            entrar(nome);
        }
    }

    async function entrar(nome) {
        PERFIL = nome;
        document.getElementById('setup-screen').style.display = 'none';
        document.getElementById('main-app').style.display = 'flex';
        const res = await fetch(`https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/main/banco_final.json?v=${Date.now()}`);
        BANCO = await res.json();
        cicloQuestao();
    }

    async function cicloQuestao() {
        document.getElementById('btn-next').style.display = 'none';
        document.getElementById('save-status').innerText = "";
        
        const feitas = (HISTORICO[PERFIL] || []).map(h => h.id);
        const disponiveis = BANCO.filter(q => !feitas.includes(q.id));
        ATUAL = disponiveis[Math.floor(Math.random() * disponiveis.length)] || BANCO[0];
        
        renderizarQuestao();
    }

    async function renderizarQuestao() {
        document.getElementById('meta-info').innerText = ATUAL.info;
        
        // TEXTO ASSOCIADO
        const wrapper = document.getElementById('wrapper-assoc');
        const areaAssoc = document.getElementById('q-texto-assoc');
        let htmlAssoc = ATUAL.htmlTextoAssociado || ATUAL.txtAssoc;
        if (htmlAssoc && htmlAssoc.trim().length > 5) {
            wrapper.style.display = 'block'; areaAssoc.innerHTML = htmlAssoc;
        } else { wrapper.style.display = 'none'; }

        // ENUNCIADO E ALTS
        document.getElementById('q-enunciado').innerHTML = ATUAL.htmlEnunciado || ATUAL.enunciado;
        const altArea = document.getElementById('q-alternativas');
        altArea.innerHTML = '';
        const letras = ['A', 'B', 'C', 'D', 'E'];
        ATUAL.alts.forEach((texto, i) => {
            const div = document.createElement('div');
            div.className = 'opcao';
            let imgs = "";
            if(ATUAL.imgsAlternativas && ATUAL.imgsAlternativas[i]) {
                ATUAL.imgsAlternativas[i].forEach(url => imgs += `<img src="${url}" style="display:block; max-width:100%; margin-top:10px;">`);
            }
            div.innerHTML = `<div class="letra">${letras[i]}</div><div style="flex:1">${texto}${imgs}</div>`;
            div.onclick = () => validar(letras[i], div);
            altArea.appendChild(div);
        });

        // GERA√á√ÉO/BUSCA DE SUBS√çDIO (FOCO TOTAL)
        if (SUBSIDIOS[ATUAL.id]) {
            document.getElementById('preventivo-texto').innerText = SUBSIDIOS[ATUAL.id];
            document.getElementById('save-status').innerText = "‚úì LIDO DO GITHUB";
        } else {
            document.getElementById('preventivo-texto').innerText = "IA Gerando subs√≠dio did√°tico...";
            const sub = await callGroq(`Explique o tema ${ATUAL.disciplinas ? ATUAL.disciplinas.join(", ") : "desta quest√£o"} de forma did√°tica e puramente t√©cnica. N√ÉO cite a resposta, N√ÉO analise o enunciado. Ensine o conceito cru para que o aluno possa responder sozinho.`, "llama-3.1-8b-instant");
            document.getElementById('preventivo-texto').innerText = sub;
            SUBSIDIOS[ATUAL.id] = sub;
            await salvarArquivo(FILE_SUBSIDIOS, SUBSIDIOS);
            document.getElementById('save-status').innerText = "‚úì SALVO NO GITHUB";
            document.getElementById('total-subsidios').innerText = `${Object.keys(SUBSIDIOS).length} Subs√≠dios salvos no GitHub.`;
        }
    }

    async function validar(letra, el) {
        document.querySelectorAll('.opcao').forEach(o => o.style.pointerEvents = 'none');
        const correta = letra === ATUAL.gabarito;
        el.classList.add(correta ? 'correct' : 'wrong');
        if(!correta) {
            document.querySelectorAll('.opcao').forEach(o => {
                if(o.querySelector('.letra').innerText === ATUAL.gabarito) o.classList.add('correct');
            });
        }
        HISTORICO[PERFIL].push({id: ATUAL.id, ok: correta});
        await salvarArquivo(FILE_HISTORICO, HISTORICO);
        document.getElementById('btn-next').style.display = 'block';
    }

    async function salvarArquivo(nome, objeto) {
        try {
            const url = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${nome}`;
            const res = await fetch(url, { headers: { Authorization: `token ${GITHUB_TOKEN}` } });
            const data = await res.json();
            await fetch(url, {
                method: "PUT",
                headers: { Authorization: `token ${GITHUB_TOKEN}`, "Content-Type": "application/json" },
                body: JSON.stringify({ 
                    message: "Update", 
                    content: btoa(unescape(encodeURIComponent(JSON.stringify(objeto)))), 
                    sha: data.sha 
                })
            });
        } catch (e) { console.error("Erro ao salvar:", e); }
    }

    async function callGroq(p, m) {
        const r = await fetch("https://api.groq.com/openai/v1/chat/completions", {
            method: "POST",
            headers: { Authorization: `Bearer ${GROQ_KEY}`, "Content-Type": "application/json" },
            body: JSON.stringify({ model: m, messages: [{role: "user", content: p}] })
        });
        const d = await r.json();
        return d.choices[0].message.content;
    }

    function toggleTexto() {
        const txt = document.getElementById('q-texto-assoc');
        txt.classList.toggle('expandido');
    }

    init();
</script>
</body>
</html>
